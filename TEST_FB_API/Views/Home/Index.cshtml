@{
    ViewBag.Title = "Home Page";
}

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script>

<script>
    function statusChangeCallback(response) {
        if (response.status === 'connected') {
            testAPI();
        } else {
            document.getElementById('status').innerHTML = 'Please log into this app.';
        }
    }

    // This function is called when someone finishes with the Login Button.
    // See the onlogin handler attached to it in the sample code below.
    function checkLoginState() {
        FB.getLoginStatus(function (response) {
            statusChangeCallback(response);
        });
    }

    window.fbAsyncInit = function () {
        FB.init({
            appId: '485102995357580',
            cookie: true,  // enable cookies to allow the server to access the session
            xfbml: true,  // parse social plugins on this page
            version: 'v3.2' // The Graph API version to use for the call
        });

        //FB.getLoginStatus(function (response) {
        //    statusChangeCallback(response);
        //});
    };

    // Load the SDK asynchronously
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) return;
        js = d.createElement(s); js.id = id;
        js.src = "https://connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));

    // Here we run a very simple test of the Graph API after login is
    // successful.  See statusChangeCallback() for when this call is made.
    function testAPI() {
        alert('Welcome!  Fetching your information.... ');
        scopeList = 'id,name,birthday,friends';
        FB.api('/me?fields=' + scopeList, function (response) {
            alert('Successful login for: ' + response.name);
            document.getElementById('status').innerHTML =
                'Thanks for logging in, ' + response.id + '!' + '<br>' +
                'BDay : ' + response.birthday;
            console.log(response);
        });
    }

    logInWithFacebook = function () {
        FB.login(function (response) {
            if (response.authResponse) {
                alert('You are logged in &amp; cookie set!');
                checkLoginState();
                // Now you can redirect the user or do an AJAX request to
                // a PHP script that grabs the signed request from the cookie.
            } else {
                alert('User cancelled login or did not fully authorize.');
                checkLoginState();
            }
        }, { scope: 'user_birthday'/*, 'user_friends'*/ });
        return false;
    };

    function GetTestUsersBirthday() {
        $.ajax({
            method: 'POST',
            url: '@Url.Action("GetChartData", "Home")',
            success: function (result) {
                alert("isSuccess " + result.isSuccess + "<br>Message " + result.errorMsg);

                var barChartData = prepareBarChartData(result.barChartData);
                barChart(barChartData.label, barChartData.datasets);
            }
        });
    }

    function prepareBarChartData(barChartData) {
        var label = [];
        var datasets = [];
        var backgroundColorList = [
            'rgba(54, 162, 235, 0.2)',
            'rgba(255, 99, 132, 0.2)',
            'rgba(255, 205, 86, 0.2)',
            'rgba(75, 192, 192, 0.2)',
            'rgba(255, 159, 64, 0.2)'
        ]
        var borderColorList = [
            'rgba(54, 162, 235, 1)',
            'rgba(255, 99, 132, 1)',
            'rgba(255, 205, 86, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 159, 64, 1)'
        ]

        for (var i = barChartData.minAge; i < barChartData.maxAge + 1; i++) {
            label.push(i);
        }

        var bgColorIndex = 0;
        $(barChartData.userList).each(function () {
            var data = [];

            $(this.innerData).each(function () {
                data.push(this.count);
            })

            datasets.push({
                label: this.gender,
                data: data,
                backgroundColor: backgroundColorList[bgColorIndex],
                borderColor: borderColorList[bgColorIndex],
                borderWidth: 1
            })
            bgColorIndex += 1;
        })

        var barChart = {
            label: label,
            datasets: datasets
        }

        return barChart;
    }

    function barChart(label, dataset) {
        var canvas = $("#dateBarChart");
        var chart = new Chart(canvas, {
            type: 'bar',
            data: {
                labels: label,
                datasets: dataset
            },
            options: {
                responsive: false,
                title: {
                    display: true,
                    text: "Distribution of Test Users' Age By Gender"
                },
                scales: {
                    xAxes: [{
                        stacked: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Age'
                        },
                        ticks: {
                            autoSkip: false
                        }
                    }],
                    yAxes: [{
                        stacked: true,
                        scaleLabel: {
                            display: true,
                            labelString: '# of people'
                        },
                        ticks: {
                            stepSize: 1,
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }
</script>

<div class="jumbotron">
    <h1>ASP.NET</h1>
    <p class="lead">ASP.NET is a free web framework for building great Web sites and Web applications using HTML, CSS and JavaScript.</p>
    <p><a href="https://asp.net" class="btn btn-primary btn-lg">Learn more &raquo;</a></p>
    <p><a href="#" onClick="logInWithFacebook();">Log In with JavaScript SDK</a></p>
    <p><fb:login-button scope="user_birthday" onlogin="checkLoginState();"></fb:login-button></p>
    <p id="status">Stuff here</p>
    <p><input type="button" class="btn btn-primary btn-lg" value="Execute Ajax" onclick="GetTestUsersBirthday()" /></p>
    <p><canvas id="dateBarChart" style="width: 500px; height: 500px"></canvas></p>
</div>

<div class="row">
    <div class="col-md-4">
        <h2>Getting started</h2>
        <p>
            ASP.NET MVC gives you a powerful, patterns-based way to build dynamic websites that
            enables a clean separation of concerns and gives you full control over markup
            for enjoyable, agile development.
        </p>
        <p><a class="btn btn-default" href="https://go.microsoft.com/fwlink/?LinkId=301865">Learn more &raquo;</a></p>
    </div>
    <div class="col-md-4">
        <h2>Get more libraries</h2>
        <p>NuGet is a free Visual Studio extension that makes it easy to add, remove, and update libraries and tools in Visual Studio projects.</p>
        <p><a class="btn btn-default" href="https://go.microsoft.com/fwlink/?LinkId=301866">Learn more &raquo;</a></p>
    </div>
    <div class="col-md-4">
        <h2>Web Hosting</h2>
        <p>You can easily find a web hosting company that offers the right mix of features and price for your applications.</p>
        <p><a class="btn btn-default" href="https://go.microsoft.com/fwlink/?LinkId=301867">Learn more &raquo;</a></p>
    </div>
</div>